import{_ as se,j as re,G as le,u as oe,r as g,l as A,q as ie,o as ne,a as c,c as d,f as a,h as L,e as l,t as s,F as N,d as D,g as k,y as U,X as ce,p as W,A as de,i as q,H as ue,x as H,Q as _e}from"./index-e55b2fbe.js";const ve={class:"max-w-7xl mx-auto p-4 sm:p-6 lg:p-8 font-inter"},ye={class:"flex lg:flex-row flex-col gap-10"},me={class:"flex-1 bg-white rounded-2xl shadow-lg p-6"},pe={key:0,class:"flex justify-center items-center py-12 gap-4"},be={class:"text-lg text-gray-700"},fe={key:1},he={class:"mb-8"},ge={class:"text-lg font-semibold text-gray-800 mb-4"},xe={class:"flex flex-wrap gap-3"},we=["onClick"],ke={key:0,class:"text-xs block opacity-80"},qe={class:"mb-8"},Ce={class:"text-lg font-semibold text-gray-800 mb-3"},Fe={key:0,class:"relative flex gap-3 items-center"},Se={value:null,disabled:""},Ae=["value"],Ne={key:1,class:"p-4 bg-red-100 border border-red-300 rounded-lg"},De={class:"text-red-700 font-medium mb-3"},$e={key:0,class:"text-center py-16 text-gray-500 text-lg"},je={key:1},Ie=["src","alt"],Te={class:"flex-1"},Ee={class:"font-semibold text-gray-900 text-lg"},Me={class:"text-yellow-700 text-sm mt-1"},Be={key:0,class:"text-sm m-1 text-[#0b3baa] line-through opacity-80"},Oe={class:"flex flex-wrap items-center gap-6 mt-4"},Pe={class:"flex items-center border border-gray-300 rounded-lg overflow-hidden"},Ve=["onClick","disabled"],ze={class:"w-16 text-center font-medium py-2"},Le=["onClick"],Ue=["onClick"],We={class:"text-xl font-bold text-gray-800 mb-4"},He={class:"font-semibold"},Re={class:"space-y-3 text-sm"},Xe={class:"flex justify-between"},Je={class:"text-gray-600"},Ke={class:"font-medium"},Ye={class:"flex justify-between"},Ze={class:"text-gray-600"},Qe={class:"flex justify-between"},Ge={class:"text-gray-600"},et={class:"flex justify-between"},tt={class:"text-gray-600"},at={key:0,class:"flex justify-between"},st={class:"text-green-600 font-medium"},rt={class:"text-green-600 font-medium"},lt={class:"flex justify-between"},ot={class:"text-gray-600"},it={class:"flex justify-between text-lg font-bold text-gray-900 pt-4 border-t border-amber-300"},nt=["onClick","disabled"],ct={class:"lg:w-96 w-full bg-white rounded-2xl shadow-lg p-6 h-fit sticky top-6"},dt={class:"text-xl font-bold text-gray-800 mb-6"},ut={class:"space-y-4 text-sm border-b pb-6"},_t={class:"flex justify-between"},vt={class:"text-gray-600"},yt={class:"flex justify-between"},mt={class:"text-gray-600"},pt={key:0,class:"flex justify-between"},bt={class:"text-green-600 font-medium"},ft={class:"text-green-600 font-medium"},ht={class:"flex justify-between text-xl font-bold pt-4 text-gray-900"},gt={class:"text-yellow-700"},xt={class:"mt-8"},wt=["placeholder"],kt=["disabled"],qt=["disabled"],Ct={key:0,class:"text-red-500 text-xs mt-2 text-center"},Ft={__name:"cart",setup(St){const{t,locale:$}=re(),u=le(),R=oe(),j=g(!0),C=g([]),y=g(null),m=g(""),b=g([]),x=g([]),_=g([]),f=g([]),T=r=>`${r.store_id}-${r.market_id||"default"}`,X=async()=>{try{const{data:r}=await q.get("/api/home/address");if(r.is_success)if(C.value=r.data,C.value.length>0){const o=C.value.find(e=>e.is_default);y.value=o?o.id:C.value[0].id}else y.value=null}catch{u.add({severity:"error",summary:t("error"),detail:t("cart.addressLoadError"),life:4e3})}},J=async()=>{try{j.value=!0;const{data:r}=await q.get("/api/cart");if(!r.is_success)return;const o=[],e=new Map;r.data.stores.forEach(i=>{const v=T(i);e.has(v)||e.set(v,{unique_store_id:v,store_id:i.store_id,display_name:$.value==="ar"?i.store_name_ar:i.store_name_en,market_name:$.value==="ar"?i.market_name_ar:i.market_name_en}),i.items.forEach(n=>{var P,V,z;console.log(n);const S=((P=n.variant)==null?void 0:P.price)||n.product.base_price||0,p=((z=(V=n.product.media)==null?void 0:V[0])==null?void 0:z.url)||n.product.key_default_image||"/images/placeholder-product.png";o.push({uniqueId:`${n.product_id}-${n.variant_id||"novar"}-${v}-${Date.now()}`,product_id:n.product_id,variant_id:n.variant_id||null,name:$.value==="ar"?n.product.name_ar:n.product.name_en,img:p,price:Number(S).toFixed(2),total_discounts_value:n.product.total_discounts_value,quantity:n.quantity,store_id:i.store_id,unique_store_id:v})})}),x.value=Array.from(e.values()),b.value=o,x.value.length>0&&(_.value=x.value.map(i=>i.unique_store_id)),await F()}catch{u.add({severity:"error",summary:t("error"),detail:t("cart.cartLoadError"),life:4e3})}finally{j.value=!1}},w=A(()=>_.value.length===0?[]:b.value.filter(r=>_.value.includes(r.unique_store_id))),E=A(()=>C.value.length>0),h=A(()=>f.value.length===0?{subtotal:0,tax:0,total:0,coupon:0,unavailable:!1}:f.value.reduce((o,e)=>({subtotal:o.subtotal+Number(e.subtotal||0),tax:o.tax+Number(e.tax||0),total:o.total+Number(e.total||0),coupon:o.coupon+Number(e.coupon||0),unavailable:o.unavailable||e.delivery_status==="not_available"}),{subtotal:0,tax:0,total:0,coupon:0,unavailable:!1})),M=A(()=>y.value&&w.value.length>0),F=async()=>{if(!y.value||w.value.length===0){f.value=[];return}try{const r={address_id:y.value,view:!0,items:w.value.map(e=>({product_id:e.product_id,variant_id:e.variant_id,quantity:e.quantity}))};m.value.trim()&&(r.coupon=m.value.trim());const{data:o}=await q.post("/api/order/view",r);o.is_success&&(f.value=o.data.map(e=>({...e,subtotal:parseFloat(e.subtotal),tax:parseFloat(e.tax),total:parseFloat(e.total),coupon:parseFloat(e.coupon),total_service_fees:parseFloat(e.total_service_fees),delivery_fee:parseFloat(e.delivery_fee||0),unique_store_id:T({store_id:e.store_id,market_id:e.market_id})})))}catch(r){console.error("Failed to fetch order totals:",r),f.value=[]}},B=r=>{const o=x.value.find(e=>e.unique_store_id===r);return o?`${o.display_name}${o.market_name?` (${o.market_name})`:""}`:t("cart.unknownStore")},I=()=>{R.push({name:"add-addres"})},K=r=>{switch(r){case"available":return t("cart.statusAvailable");case"free":return t("cart.statusFree");case"not_available":return t("cart.statusNotAvailable");default:return r}},Y=r=>{switch(r){case"available":case"free":return"bg-green-100 text-green-800 border-green-300";case"not_available":return"bg-red-100 text-red-800 border-red-300";default:return"bg-yellow-100 text-yellow-800 border-yellow-300"}},Z=r=>{_.value=_.value.includes(r)?_.value.filter(o=>o!==r):[..._.value,r]},Q=()=>{_.value=x.value.map(r=>r.unique_store_id)},O=async(r,o)=>{if(!(o<1))try{await q.post("/api/cart/update",{product_id:r.product_id,variant_id:r.variant_id,quantity:o}),r.quantity=o,await F(),u.add({severity:"success",summary:t("success"),detail:o>r.quantity?t("cart.quantityIncreased"):t("cart.quantityDecreased"),life:2e3})}catch{u.add({severity:"error",summary:t("error"),detail:t("cart.quantityUpdateError"),life:4e3})}},G=async r=>{try{await q.post("/api/cart/remove",{product_id:r.product_id,variant_id:r.variant_id}),b.value=b.value.filter(o=>o.uniqueId!==r.uniqueId),await F(),u.add({severity:"success",summary:t("success"),detail:t("cart.removeSuccess"),life:3e3})}catch{u.add({severity:"error",summary:t("error"),detail:t("cart.removeError"),life:4e3})}},ee=async()=>{await F(),u.add({severity:"success",summary:t("success"),detail:t("cart.couponApplied"),life:3e3})},te=async r=>{var i,v;const o=f.value.find(n=>n.unique_store_id===r);if(!y.value){u.add({severity:"warn",summary:t("warning"),detail:t("cart.selectAddressFirst"),life:4e3});return}if(o&&o.delivery_status==="not_available"){u.add({severity:"error",summary:t("error"),detail:t("cart.cannotCheckoutDueToDelivery"),life:5e3});return}const e=w.value.filter(n=>n.unique_store_id===r);if(e.length===0){u.add({severity:"info",summary:t("info"),detail:t("cart.noItemsInStore"),life:3e3});return}try{const n={address_id:y.value,items:e.map(p=>({product_id:p.product_id,variant_id:p.variant_id,quantity:p.quantity}))};m.value.trim()&&(n.coupon=m.value.trim());const{data:S}=await q.post("/api/order",n);S.is_success&&(u.add({severity:"success",summary:t("success"),detail:t("cart.orderSuccessStore",{store:B(r)}),life:5e3}),b.value=b.value.filter(p=>p.unique_store_id!==r),_.value=_.value.filter(p=>p!==r),await F())}catch(n){const S=((v=(i=n.response)==null?void 0:i.data)==null?void 0:v.message)||t("cart.orderError");u.add({severity:"error",summary:t("error"),detail:S,life:5e3})}},ae=async()=>{var r,o;if(!M.value){if(!y.value&&!E.value){u.add({severity:"error",summary:t("error"),detail:t("cart.selectAddressWarning"),life:5e3}),I();return}u.add({severity:"warn",summary:t("warning"),detail:t("cart.cannotCheckout"),life:4e3});return}if(h.value.unavailable){u.add({severity:"error",summary:t("error"),detail:t("cart.cannotCheckoutDueToDelivery"),life:5e3});return}try{const e={address_id:y.value,items:w.value.map(v=>({product_id:v.product_id,variant_id:v.variant_id,quantity:v.quantity}))};m.value.trim()&&(e.coupon=m.value.trim());const{data:i}=await q.post("/api/order",e);i.is_success&&(u.add({severity:"success",summary:t("success"),detail:t("cart.orderSuccess"),life:5e3}),b.value=b.value.filter(v=>!_.value.includes(v.unique_store_id)),f.value=[],_.value=[])}catch(e){const i=((o=(r=e.response)==null?void 0:r.data)==null?void 0:o.message)||t("cart.orderError");u.add({severity:"error",summary:t("error"),detail:i,life:5e3})}};return ie(()=>[y.value,_.value,m.value],F,{deep:!0}),ne(()=>{X(),J()}),(r,o)=>(c(),d("div",ve,[a("div",ye,[a("section",me,[j.value?(c(),d("div",pe,[L(l(ue),{style:{width:"50px",height:"50px"},strokeWidth:"4",class:"text-yellow-600"}),a("p",be,s(l(t)("loading")),1)])):(c(),d("div",fe,[a("div",he,[a("h3",ge,s(l(t)("cart.selectStore")),1),a("div",xe,[(c(!0),d(N,null,D(x.value,e=>(c(),d("button",{key:e.unique_store_id,onClick:i=>Z(e.unique_store_id),class:H(["px-5 py-3 rounded-lg text-sm font-medium transition-all",_.value.includes(e.unique_store_id)?"bg-yellow-600 text-white shadow-md":"bg-amber-50 text-yellow-700 hover:bg-amber-100"])},[W(s(e.display_name)+" ",1),e.market_name?(c(),d("span",ke," ("+s(e.market_name)+") ",1)):k("",!0)],10,we))),128)),x.value.length>1?(c(),d("button",{key:0,onClick:Q,class:"px-5 py-3 rounded-lg text-sm font-medium bg-amber-50 text-yellow-700 hover:bg-amber-100 transition-all"},s(l(t)("cart.selectAllStores")),1)):k("",!0)])]),a("div",qe,[a("h3",Ce,s(l(t)("cart.selectAddress")),1),E.value?(c(),d("div",Fe,[U(a("select",{"onUpdate:modelValue":o[0]||(o[0]=e=>y.value=e),class:"flex-1 bg-amber-50 border border-amber-300 rounded-lg px-4 py-1 text-gray-800 focus:outline-none focus:ring-2 focus:ring-yellow-600"},[a("option",Se,s(l(t)("cart.selectAddressPlaceholder")),1),(c(!0),d(N,null,D(C.value,e=>(c(),d("option",{key:e.id,value:e.id},s(e.address_line_1)+", "+s(e.city),9,Ae))),128))],512),[[ce,y.value]]),a("button",{onClick:I,class:"px-5 py-3 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300 transition duration-200 text-sm flex-shrink-0"},s(l(t)("cart.addAddressButton")),1)])):(c(),d("div",Ne,[a("p",De,[o[2]||(o[2]=a("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-5 w-5 inline-block -mt-0.5",viewBox:"0 0 20 20",fill:"currentColor"},[a("path",{"fill-rule":"evenodd",d:"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z","clip-rule":"evenodd"})],-1)),W(" "+s(l(t)("cart.selectAddressWarning")),1)]),a("button",{onClick:I,class:"w-full py-2 bg-yellow-600 text-white font-semibold rounded-lg hover:bg-yellow-700 transition duration-200"},s(l(t)("cart.addAddressButton")),1)]))]),w.value.length===0?(c(),d("div",$e,s(_.value.length===0?l(t)("cart.selectStorePrompt"):l(t)("cart.emptyCart")),1)):(c(),d("div",je,[(c(!0),d(N,null,D(w.value,e=>(c(),d("div",{key:e.uniqueId,class:"flex flex-col sm:flex-row items-start sm:items-center gap-4 p-5 bg-gray-50 rounded-xl mb-4 shadow-sm hover:shadow-md transition-shadow"},[a("img",{src:e.img||"/images/placeholder-product.png",alt:e.name,class:"w-24 h-24 object-cover rounded-lg border border-gray-200",loading:"lazy"},null,8,Ie),a("div",Te,[a("h4",Ee,s(e.name),1),a("span",Me,s(l(t)("cart.price"))+": "+s(e.price-e.total_discounts_value)+" "+s(l(t)("cart.currency")),1),e.total_discounts_value?(c(),d("span",Be,s(e.price)+" "+s(r.$t("currencyLabel")),1)):k("",!0),a("div",Oe,[a("div",Pe,[a("button",{onClick:i=>O(e,e.quantity-1),disabled:e.quantity<=1,class:"w-12 h-10 text-gray-600 hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition"}," − ",8,Ve),a("span",ze,s(e.quantity),1),a("button",{onClick:i=>O(e,e.quantity+1),class:"w-12 h-10 text-gray-600 hover:bg-gray-100 transition"}," + ",8,Le)]),a("button",{onClick:i=>G(e),class:"text-red-600 hover:text-red-800 text-sm font-medium transition"},s(l(t)("cart.remove")),9,Ue)])])]))),128)),(c(!0),d(N,null,D(f.value,e=>(c(),d("div",{key:e.unique_store_id,class:"bg-gradient-to-r from-amber-50 to-yellow-50 p-6 mt-8 rounded-xl border border-amber-200"},[a("h3",We,s(l(t)("cart.orderFrom"))+" "+s(B(e.unique_store_id)),1),e.delivery_message?(c(),d("div",{key:0,class:H(["mb-4 p-4 rounded-lg text-sm",Y(e.delivery_status)])},[a("p",He,s(l(t)("cart.deliveryStatus"))+": "+s(K(e.delivery_status)),1)],2)):k("",!0),a("div",Re,[a("div",Xe,[a("span",Je,s(l(t)("cart.shippingTime")),1),a("span",Ke,s(e.delivery_time||l(t)("cart.notAvailable")),1)]),a("div",Ye,[a("span",Ze,s(l(t)("cart.deliveryFee")),1),a("span",null,s(Number(e.delivery_fee||0).toFixed(2))+" "+s(l(t)("cart.currency")),1)]),a("div",Qe,[a("span",Ge,s(l(t)("cart.subtotal")),1),a("span",null,s(Number(e.subtotal).toFixed(2))+" "+s(l(t)("cart.currency")),1)]),a("div",et,[a("span",tt,s(l(t)("cart.tax")),1),a("span",null,s(Number(e.tax).toFixed(2))+" "+s(l(t)("cart.currency")),1)]),e.coupon>0?(c(),d("div",at,[a("span",st,s(l(t)("cart.couponDiscount")),1),a("span",rt,"- "+s(Number(e.coupon).toFixed(2))+" "+s(l(t)("cart.currency")),1)])):k("",!0),a("div",lt,[a("span",ot,s(l(t)("cart.serviceFees")),1),a("span",null,s(Number(e.total_service_fees).toFixed(2))+" "+s(l(t)("cart.currency")),1)]),a("div",it,[a("span",null,s(l(t)("cart.total")),1),a("span",null,s(Number(e.total).toFixed(2))+" "+s(l(t)("cart.currency")),1)])]),a("button",{onClick:i=>te(e.unique_store_id),disabled:!y.value||e.delivery_status==="not_available",class:"w-full mt-6 py-3 bg-yellow-600 text-white font-bold rounded-lg hover:bg-yellow-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition duration-200 shadow-md"},s(l(t)("cart.checkoutThisStoreOnly")||"اطلب من هذا المتجر فقط"),9,nt)]))),128))]))]))]),a("aside",ct,[a("h3",dt,s(l(t)("cart.orderSummary")),1),a("div",ut,[a("div",_t,[a("span",vt,s(l(t)("cart.subtotal")),1),a("span",null,s(h.value.subtotal.toFixed(2))+" "+s(l(t)("cart.currency")),1)]),a("div",yt,[a("span",mt,s(l(t)("cart.tax")),1),a("span",null,s(h.value.tax.toFixed(2))+" "+s(l(t)("cart.currency")),1)]),h.value.coupon>0?(c(),d("div",pt,[a("span",bt,s(l(t)("cart.couponDiscount")),1),a("span",ft,"- "+s(h.value.coupon.toFixed(2))+" "+s(l(t)("cart.currency")),1)])):k("",!0),a("div",ht,[a("span",null,s(l(t)("cart.total")),1),a("span",gt,s(h.value.total.toFixed(2))+" "+s(l(t)("cart.currency")),1)])]),a("div",xt,[U(a("input",{"onUpdate:modelValue":o[1]||(o[1]=e=>m.value=e),type:"text",placeholder:l(t)("cart.couponPlaceholder"),class:"w-full px-4 py-3 border border-amber-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-600 transition"},null,8,wt),[[de,m.value]]),a("button",{onClick:ee,disabled:!m.value.trim(),class:"w-full mt-3 py-3 bg-amber-100 text-yellow-700 font-semibold rounded-lg hover:bg-amber-200 disabled:opacity-60 disabled:cursor-not-allowed transition"},s(l(t)("cart.applyCoupon")),9,kt)]),a("button",{onClick:ae,disabled:!M.value||h.value.unavailable,class:"w-full mt-8 py-4 bg-gray-900 text-white font-bold text-lg rounded-lg hover:bg-gray-800 disabled:bg-gray-400 disabled:cursor-not-allowed transition duration-200"},s(l(t)("cart.checkoutAll")||"إتمام الطلب (الكل)"),9,qt),h.value.unavailable?(c(),d("p",Ct,s(l(t)("cart.cannotCheckoutDueToDelivery")),1)):k("",!0)])]),L(l(_e))]))}},Nt=se(Ft,[["__scopeId","data-v-e8b4dbdb"]]);export{Nt as default};
